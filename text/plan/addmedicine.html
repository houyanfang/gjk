<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title></title>
    <style type="text/css">
        @-ms-viewport {
            width: device-width;
        }

        @-o-viewport {
            width: device-width;
        }

        @viewport {
            width: device-width;
        }

        body .loadingImg {
            position: absolute;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            top: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        body .loadingImg img {
            width: 50px;
            height: 50px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
    </style>

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script>
        // Copyright 2014-2015 Twitter, Inc.
        // Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
        if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
            var msViewportStyle = document.createElement('style')
            msViewportStyle.appendChild(
                document.createTextNode(
                    '@-ms-viewport{width:auto!important}'
                )
            )
            document.querySelector('head').appendChild(msViewportStyle)
        }
    </script>
    <link rel="stylesheet" href="../css/boot.css"/>
    <link rel="stylesheet" href="../css/theme.css"/>
    <!--<link rel="stylesheet" href="../css/newtheme.css">-->
    <link rel="stylesheet" href="../css/addplan.css"/>

</head>
<body>
<div class="page-group">
    <div class="page page-current">
        <div role="navigation" class="navbar-fixed-top">
            <div class="container-fluid">
                <div class="pull-left">
                    <a role="backlink" class="glyphicon glyphicon-menu-left" href="javascript:history.go(-1);"></a>
                </div>
                <div class="pull-right">
                    <a href="javascript:void();"></a>
                </div>
                <div id="pageTitle" role="navtitle">
                    添加服药计划
                </div>
            </div>
        </div>
        <div class="content">
            <div id="list">
                <!--用户没有找到药品，显示-->
                <div class="missMedicine" style="display: none;"></div>

                <form id="medicineForm" action="" method="post" target="">

                    <!--药品相关设置-->
                    <div class="list-block" id="getMedicineData">
                        <ul>
                            <li class="item-content item-link gjk-item  gjk-open-calendar">
                                <div class="item-inner gjk-item-inner">
                                    <div class="item-title">开始时间</div>
                                    <div class="item-input item-calendar item-start">
                                        <input type="text" placeholder="点击选择日期" readonly="">
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-link gjk-item gjk-open-calendar">
                                <div class="item-inner gjk-item-inner">
                                    <div class="item-title">结束时间</div>
                                    <div class="item-input item-calendar item-end">
                                        <input type="text" placeholder="点击选择日期" readonly="">
                                    </div>
                                </div>
                            </li>
                            <li class="item-content item-link gjk-item gjk-open-calendar">
                                <div class="item-inner gjk-item-inner item-auto">
                                    <div class="item-title">药品商品名</div>
                                    <a class="medicine" href="medicine.html">
                                        <div class="item-input item-name medicineName">
                                            <input id="medicalName" type="text" placeholder="药品A" readonly>
                                        </div>
                                    </a>
                                </div>
                            </li>
                            <li class="item-content item-link gjk-item gjk-open-calendar">
                                <div class="item-inner gjk-item-inner item-auto">
                                    <div class="item-title">药品通用名</div>
                                    <a class="medicine" href="medicine.html">
                                        <div class="item-input item-name medicineName">
                                            <input id="normalName" type="text" placeholder="药品A" readonly>
                                        </div>
                                    </a>
                                </div>
                            </li>
                            <li class="item-content item-link  gjk-item gjk-open-calendar">
                                <div class="item-inner gjk-item-inner item-auto">
                                    <div class="item-title">生产厂商</div>
                                    <a class="medicine" href="medicine.html">
                                        <div class="item-input item-name">
                                            <input id="manufacturer" type="text" placeholder="未知" readonly>
                                        </div>
                                    </a>
                                </div>
                            </li>
                            <li class="item-content item-link  gjk-item gjk-open-calendar">
                                <div class="item-inner gjk-item-inner item-auto">
                                    <div class="item-title">药品单位</div>
                                    <div class="item-input item-name itemInit">
                                        <input type="text" placeholder="粒" readonly>
                                    </div>
                                </div>
                            </li>
                            <li class="item-content gjk-item">
                                <div class="item-inner gjk-item-inner">
                                    <div class="item-title">每次服用</div>
                                    <div class="item-after item-number">
                                        <i class="input-reduce">-</i>
                                        <span class="input-views">1</span>
                                        <i class="input-plus">+</i>
                                    </div>
                                </div>
                            </li>
                            <li class="item-content gjk-item">
                                <div class="item-inner gjk-item-inner">
                                    <div class="item-title">每日次数</div>
                                    <div class="item-after item-count">
                                        <i class="input-reduce">-</i>
                                        <span class="input-views">1</span>
                                        <i class="input-plus">+</i>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <!--服药提醒设置-->
                    <div class="content-block-title">设置服药提醒：</div>
                    <div class="list-block">
                        <ul>
                            <li class="item-content gjk-item">
                                <div class="item-inner gjk-item-inner row">
                                    <div class="col-50 field">提醒时间</div>
                                    <div class="col-50 field">提醒开关</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="list-block list-blockx" id="switchHtml">
                        <ul>
                            <li class="item-content gjk-item">
                                <div class="item-inner gjk-item-inner row">
                                    <div class="col-50 input-wrapper">
                                        <div class="item-input item-time">
                                            <label class="label-time gjk-open-input">
                                                <div class="timebox">
                                                    <input data-num="0" type="text" placeholder="8:00" readonly>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-50 input-wrapper">
                                        <div class="item-input item-switch">
                                            <label class="label-switch" data-state="1">
                                                <input type="checkbox" checked>
                                                <div class="checkbox"></div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="content-block">
                        <p><a href="#" class="button button-big btn-save open-preloader-title ">保存</a></p>
                    </div>

                </form>

            </div>
        </div>
    </div>
</div>
<div id="longModel">
    <div class="modelBody">
        <div class="modelContext">
            <p>添加成功！</p>
            <p>是否去完善药品信息？</p>
        </div>
        <div class="modelFooter">
            <a href="javascript:;" class="btnRes">取消</a>
            <a href="javascript:;" class="btnOk">确定</a>
        </div>
    </div>
</div>
<div class="loadingImg" style="display: none">
    <img src="../img/loading.gif">
</div>
<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<!--script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.js' charset='utf-8'></script-->
<script type="text/javascript" src="../js/sm.js" charset="utf-8"></script>
<script src="../js/underscore.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="../js/zepto.touch.js" charset="utf-8"></script>
<script src="../js/gjk.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/fx.js"></script>
<script src="../js/zepto.scroll.js"></script>
<!--<script src="../js/touch.js" type="text/javascript" charset="utf-8"></script>-->
<script src="../js/cookie.js"></script>
<script src="../js/base.js"></script>
<script type='text/javascript'>
    $(document).ready(function () {
        $.init();
        /*tap  替换成了click */
        $.refreshScroller();
        var start = new Date();
        start.setDate(start.getDate() - 1);
        var startCalendar = $(".item-calendar.item-start input").calendar({
            dateFormat: 'yyyy-mm-dd',
            value: [new Date()],
            minDate: start,
            onChange: function (p, values, displayValues) {
                var nextS = new Date(displayValues);
                var nextE = new Date(displayValues);
                nextE.setDate(nextE.getDate() + 60);
                $(".item-calendar.item-end input").val(nextE.toJSON().substring(0, 10));
                endCalendar[0].destroy();
                endCalendar = $(".item-calendar.item-end input").calendar({
                    dateFormat: 'yyyy-mm-dd',
                    value: [nextE],
                    minDate: nextS,
                    maxDate: nextE
                });
            }
        });
        var endCalendar = $(".item-calendar.item-end input").calendar();

        $(".label-checkbox").click(function (e) {
            if ($(this).hasClass('checked')) {
                $(this).removeClass('checked');
                $(this).find('.checkbox-2').removeClass('checked');
                $(this).find('input').attr('checked', 'checked');
            } else {
                $(this).addClass('checked');
                $(this).find('.checkbox-2').addClass('checked');
                $(this).find('input').removeAttr('checked');
            }
            e.preventDefault();
        });
        var __this;
        $('#switchHtml ul').on('click', '.item-time input', function () {
//        console.log($('.item-time input').index($(this)));
            __this = $(this);
            $(this).picker({
                toolbarTemplate: '<header class="bar bar-nav">\
				<button class="button button-link pull-left close-picker">取消</button>\
				<button class="button button-link pull-right close-picker">确定</button>\
				<h1 class="title">选择时间</h1>\
				</header>',
                cols: [
                    {
                        textAlign: 'center',
//                    values: ['8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '1', '2', '3', '4', '5', '6', '7']
                        values: createNumber($('.item-time input').index($(this)))
                    },
                    {
                        textAlign: 'center',
                        values: [':']
                    },
                    {
                        textAlign: 'center',
                        values: ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59']
                    }
                ],
                formatValue: function (p, v, d) {
                    return (d[0] + ':' + d[2]);
                }
            });
        });
        function createNumber(num) {
            var numArr = [
                ['08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '00', '01', '02', '03', '04', '05', '06', '07'],
                ['12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11'],
                ['18', '19', '20', '21', '22', '23', '00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17'],
                ['20', '21', '22', '23', '00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19'],
                ['22', '23', '00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21']
            ];
            return numArr[num]
        }

        if (getUrlParams().states == '-1') {
            $(".itemInit input").picker({
                toolbarTemplate: '<header class="bar bar-nav">\
		  <button class="button button-link pull-left close-picker">取消</button>\
		  <button class="button button-link pull-right close-picker">确定</button>\
		  <h1 class="title">选择次数</h1>\
		  </header>',
                cols: [
                    {
                        textAlign: 'center',
                        values: ['粒', '片', '袋', '支'],
                    }
                ],
                formatValue: function (v, d) {
                    return (d[0]);
                }
            });

            $('.medicineName input').picker({
                toolbarTemplate: '<header class="bar bar-nav">\
				<button class="button button-link pull-left close-picker">取消</button>\
				<button class="button button-link pull-right close-picker">确定</button>\
				<h1 class="title">选择药品名</h1>\
				</header>',
                cols: [
                    {
                        textAlign: 'center',
                        values: ['药品A', '药品B', '药品C', '药品D']
                    }
                ],
                formatValue: function (p, v, d) {
                    return (d[0]);
                }
            });
        }

        (function ($) {
            var options = {
                inputReduce: '.input-reduce',
                inputPlus: '.input-plus',
                inputView: '.input-views',
                min: 1,
                max: 5,
                numMax: 30,
                itemCount: 1,
                itemNum: 1,
                tipMessage: 'error',
                switchHtml: $('#switchHtml').find('ul').html(),
                btnParent: $('#switchHtml').find('ul'),
                htmlNode: []
            };
            $.extend($.fn, {
                NumberPicker: function (sets) {
                    Object.assign(options, sets);
                    var _this = this;
                    //event
                    $(this).find(options.inputReduce).click(function () {
                        if ($(this).parents('.item-after').hasClass('item-number')) {
                            if (options.itemNum > options.min) {
                                options.itemNum--
                            } else {
                                options.itemNum = options.min;
                            }
                            $(_this).find(options.inputView).text(options.itemNum);
                        } else {
                            if (options.itemCount > options.min) {
                                options.itemCount--;
                                options.htmlNode.pop();
                            } else {
                                options.itemCount = options.min;
                            }
                            $(_this).find(options.inputView).text(options.itemCount);
                            addBtn();
                            changePlaceholder();
                        }

                    });

                    $(this).find(options.inputPlus).click(function () {
                        if ($(this).parents('.item-after').hasClass('item-number')) {
                            if (options.itemNum < options.numMax) {
                                options.itemNum++
                            } else {
                                options.itemNum = options.numMax;
                            }
                            $(_this).find(options.inputView).text(options.itemNum);
                        } else {
                            if (options.itemCount < options.max) {
                                options.itemCount++;
                                options.htmlNode.push(options.switchHtml);
                                console.log(options.itemCount)
                            } else {
                                options.itemCount = options.max;
                            }
                            $(_this).find(options.inputView).text(options.itemCount);
                            addBtn();
                            changePlaceholder();
                        }
                    });
                }
            });
            //生成对应的按钮
            function addBtn() {
                var html = options.switchHtml;
                for (var i = 1; i < options.htmlNode.length + 1; i++) {

                    html += '<li class="item-content gjk-item">' +
                        '<div class="item-inner gjk-item-inner row">' +
                        '<div class="col-50 input-wrapper">' +
                        '<div class="item-input item-time">' +
                        '<label class="label-time gjk-open-input">' +
                        '<div class="timebox">' +
                        '<input data-num="' + i + '" type="text" placeholder="8：00" readonly="">' +
                        '</div>' +
                        '</label>' +
                        '</div>' +
                        '</div>' +
                        '<div class="col-50 input-wrapper">' +
                        '<div class="item-input item-switch">' +
                        '<label class="label-switch" data-state="1">' +
                        '<input type="checkbox" checked="">' +
                        '<div class="checkbox"></div>' +
                        '</label>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</li>';
                }
                options.btnParent.html(html);
            }

            function changePlaceholder() {
                var $input = $('#switchHtml').find('li .timebox input');
                $input.each(function () {
                    switch ($(this).attr('data-num')) {
                        case '0':
                            $(this).attr('placeholder', '08:00');
                            break;
                        case '1':
                            $(this).attr('placeholder', '12:00');
                            break;
                        case '2':
                            $(this).attr('placeholder', '18:00');
                            break;
                        case '3':
                            $(this).attr('placeholder', '20:00');
                            break;
                        case '4':
                            $(this).attr('placeholder', '22:00');
                            break;
                        default:
                            $(this).attr('placeholder', '08:00');
                            break;
                    }
                })
            }

            //改变状态值
            $('#switchHtml').on('click', '.label-switch', function () {
                var state = $(this).attr('data-state');
                if (state == 0) {
                    $(this).attr('data-state', 1)
                } else {
                    $(this).attr('data-state', 0)
                }
            });
        })(Zepto);

        $('.item-number').NumberPicker();
        $('.item-count').NumberPicker();

        //页面数据初始化
        function initPageData() {
            $('.item-start').find('input').attr('value', createStartAndEndDate().startDate);
            $('.item-end').find('input').attr('value', createStartAndEndDate().endDate);
        }

        initPageData();
        //生成对应的药品
        (function ($) {

            var fnData = {
                localData: JSON.parse(localStorage.localData),
                localName: getUrlParams().name,   //药品名称
                localId: getUrlParams().id,   //药品id
                localstates: getUrlParams().states,   //获得状态值，'1'为查看药品， '-1'为没有找到添加药品，
                startDate: 'startDate', //开始时间
                endDate: 'endDate',  //结束时间
                dailyTimes: 'dailyTimes',
                dose: 'dose',
                startTime: 'startTime',
                endTime: 'endTime',
                btnSubmit: '.button.button-big.btn-save'
            };

            switch (fnData.localstates) {
                case '1':
                    previweMedicine();
                    $(fnData.btnSubmit).click(saveMedicine);
                    break;
                case '-1':
                    addMedicine();
                    $(fnData.btnSubmit).click(saveMedicine);
                    break;
            }

            function resetValue() {
                $('body').on('click', '.button.button-link.pull-left.close-picker', function () {
                    __this.val('');
                })
            }

            resetValue();

            function previweMedicine() {
                $('#medicalName').val(fnData.localData.data[fnData.localId - 1].normalName);
                $('#normalName').val(fnData.localData.data[fnData.localId - 1].medicalName);
                $('#manufacturer').val(fnData.localData.data[fnData.localId - 1].manufacturer);
                $('.item-start').find('input').attr('placeholder', createStartAndEndDate().startDate)
                $('.item-end').find('input').attr('placeholder', createStartAndEndDate().endDate)
            }

            function addMedicine() {
                var fnData = {
                    title: '#pageTitle',
                    txt: '找不到相关药品',
                    dis: '<div><span class="orangeSpan"></span></div><div><span>为了不影响您的使用，我们给您生成了代号为字母的药品名称，您可以继续添加用药计划了</span></div>',
                    txtParent: '.missMedicine'
                };
//            var html =
                $(fnData.title).html(fnData.txt);
                $(fnData.txtParent).html(fnData.dis).css('display', 'block');
                $('.item-start').find('input').attr('placeholder', createStartAndEndDate().startDate);
                $('.item-end').find('input').attr('placeholder', createStartAndEndDate().endDate);
                $('a.medicine').attr('href', 'javascript:;')

            }

            //获取页面数据

            function alarmTime() {
                var input = $('.medicineName input');
                var options = {
//                    status:'0',
                    msklTreatplanId: '',
//                    userId:'',
//                    updateDatetime:'',
                    medicalName: input.picker()[0].value ? input.picker()[0].value : $('#medicalName').attr('placeholder'),
                    normalName: input.picker()[1].value ? input.picker()[1].value : $('#normalName').attr('placeholder'),
                    dose: $('.item-number').find('.input-views').html() + ".0",
                    dailyTimes: $('.item-count').find('.input-views').html(),
                    mediniceInit: $('.itemInit').find('input').attr('placeholder'),
                    alarmTime1: '',
                    alarmTime2: '',
                    alarmTime3: '',
                    alarmTime4: '',
                    alarmTime5: '',
                    startDate: $(".item-calendar.item-start input").calendar()[0].input[0].value ? $(".item-calendar.item-start input").calendar()[0].input[0].value : createStartAndEndDate().startDate,
                    endDate: $(".item-calendar.item-end input").calendar()[0].input[0].value ? $(".item-calendar.item-end input").calendar()[0].input[0].value : createStartAndEndDate().endDate,
                    manufacturer: $('#manufacturer').val()
                };
                var $input = $('#switchHtml').find('.timebox input');
                var $labelSwitch = $('.item-content').find('.label-switch');
                for (var i = 0; i < $input.length; i++) {
                    if ($input.eq(i).val() == '') {
//                        options['alarmTime' + (i + 1)] = $input.eq(i).attr('placeholder') + '|' + $labelSwitch.eq(i).attr('data-state')
                        options['alarmTime' + (i + 1)] = $input.eq(i).attr('placeholder')
                    } else {
//                        options['alarmTime' + (i + 1)] = $input.eq(i).val() + '|' + $labelSwitch.eq(i).attr('data-state')
                        options['alarmTime' + (i + 1)] = $input.eq(i).val()
                    }
                }
                return options;
            }

            //提交药品
            function saveMedicine() {
                $(fnData.btnSubmit).attr('onclick', 'return false');
                $('.loadingImg').show();
                var $longModel = $('#longModel');
                var _data = alarmTime();
//                var _url = 'treatPlan/saveTeantPlan/';
                var _url = 'treatPlan/saveTeantPlanAllTreatLog';
                var _success = function (data) {
//                    console.log(data)
                    if (data.success == true) {
                        $('.loadingImg').hide();
                        if (getUrlParams().states == '-1') {
                            $('#longModel').show();
                            $longModel.find('.btnRes').on('click', function () {
                                window.location.href = '../life/index.html';
                            });
                            $longModel.find('.btnOk').on('click', function () {
                                window.location.href = '../plan/perfectmedicine.html'
                            });
                        } else {
                            window.location.href = '../life/index.html';
                        }
                    }
                };
                var _error = function (data) {
//                    console.log(data);
//                    alert("获取数据失败！");
                };

                $.gjk.ajax.postAjax(_url, _data, _success, _error, function () {
                }, 'POST', 'modifymedicine')
            }

        })(Zepto);

        $('.item-input.item-calendar').on('click', function () {
            changePicker();
            limitTimeDate();
        });
    })
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title></title>
    <style type="text/css">
        @-ms-viewport {
            width: device-width;
        }

        @-o-viewport {
            width: device-width;
        }

        @viewport {
            width: device-width;
        }
    </style>

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script>
        // Copyright 2014-2015 Twitter, Inc.
        // Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
        if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
            var msViewportStyle = document.createElement('style')
            msViewportStyle.appendChild(
                document.createTextNode(
                    '@-ms-viewport{width:auto!important}'
                )
            )
            document.querySelector('head').appendChild(msViewportStyle)
        }
    </script>
    <link rel="stylesheet" href="../css/boot.css"/>
    <link rel="stylesheet" href="../css/theme.css"/>
    <link rel="stylesheet" href="../css/addplan.css"/>
</head>
<body>
<div class="page-group">
    <div class="page page-current">
        <div role="navigation" class="navbar-fixed-top">
            <div class="container-fluid">
                <div class="pull-left">
                    <a role="backlink" id="goBackPack" class="glyphicon glyphicon-menu-left" href="javascript:;"></a>
                </div>
                <div class="pull-right">
                    <a href="javascript:void();"></a>
                </div>
                <div role="navtitle">
                    修改运动计划
                </div>
            </div>
        </div>
        <div class="content">
            <div id="list">
                <div class="list-block">
                    <ul>
                        <li class="item-content item-link gjk-item gjk-open-calendar">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">开始时间</div>
                                <div class="item-input item-calendar item-start">
                                    <input id="startTime" type="text" placeholder="点击选择日期" readonly="">
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-link gjk-item gjk-open-calendar">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">结束时间</div>
                                <div class="item-input item-calendar item-end">
                                    <input id="endTime" type="text" placeholder="点击选择日期" readonly="">
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="list-block">
                    <ul>
                        <li class="item-content gjk-item">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 field-3">运动频次</div>
                                <div class="col-33 field-3">
                                    <span>提醒时间</span>
                                </div>
                                <div class="col-33 field-3">提醒开关</div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="list-block list-blockx">
                    <ul id="switchCheckBox">
                        <li class="item-content gjk-item alarmMonday">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox">
                                        <input type="checkbox">
                                        <div class="checkbox-2">
                                            <span>周一</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <!--<input type="checkbox">-->
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="item-content gjk-item alarmTuesday">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox" data-state="0">
                                        <input type="checkbox">
                                        <div class="checkbox-2">
                                            <span>周二</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <!--<input type="checkbox">-->
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="item-content gjk-item alarmWednesday">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox" data-state="0">
                                        <input type="checkbox">
                                        <div class="checkbox-2">
                                            <span>周三</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <!--<input type="checkbox">-->
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="item-content gjk-item alarmThursday">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox">
                                        <input type="checkbox">
                                        <div class="checkbox-2">
                                            <span>周四</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <!--<input type="checkbox">-->
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="item-content gjk-item alarmFriday">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox">
                                        <input type="checkbox">
                                        <div class="checkbox-2">
                                            <span>周五</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <!--<input type="checkbox">-->
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="item-content gjk-item alarmSaturday">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox">
                                        <input type="checkbox">
                                        <div class="checkbox-2">
                                            <span>周六</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <!--<input type="checkbox">-->
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li class="item-content gjk-item alarmSunday">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox">
                                        <input type="checkbox">
                                        <div class="checkbox-2">
                                            <span>周日</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <!--<input type="checkbox">-->
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="content-block-title">每周日记录本周运动情况：</div>
                <div class="list-block">
                    <ul>
                        <li class="item-content gjk-item">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-50 field">提醒时间</div>
                                <div class="col-50 field">提醒开关</div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="list-block list-blockx">
                    <ul>
                        <li class="item-content gjk-item alarmWeekday">
                            <div class="item-inner gjk-item-inner row">
                                <div class=" input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox checked">
                                        <input type="checkbox">
                                    </label>
                                </div>
                                <div class="col-50 input-wrapper">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-50 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <input type="checkbox">
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="content-block">
                    <p><a href="#" class="button button-big btn-save">保存</a></p>
                    <p><a href="#" class="button button-big btn-del">删除</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
<!--删除按钮-->
<div id="longModel">
    <div class="modelBody">
        <div class="modelContext">
            <!--<p>添加成功！</p>-->
            <p>确定要删除信息吗？</p>
        </div>
        <div class="modelFooter">
            <a href="javascript:;" class="btnRes">取消</a>
            <a href="javascript:;" class="btnOk">确定</a>
        </div>
    </div>
</div>
<!--model层-->
<div id="reminder">
    <div class="reminderBody">
        <div class="reminderContext">
            <div><span id="msg"></span><!--<span id="num">2s</span>--></div>
        </div>
    </div>
</div>
<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<!--script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.js' charset='utf-8'></script-->
<script type="text/javascript" src="../js/sm.js" charset="utf-8"></script>
<script type="text/javascript" src="../js/zepto.touch.js" charset="utf-8"></script>
<script src="../js/underscore.js"></script>
<script src="../js/cookie.js"></script>
<script src="../js/gjk.js"></script>
<script src="../js/base.js"></script>
<script type='text/javascript'>
    $(document).ready(function () {
        $.init();
        /*tap  替换成了click */
        $.refreshScroller();
        var start = new Date();
        start.setDate(start.getDate() - 1);
        var startCalendar = $(".item-calendar.item-start input").calendar({
            dateFormat: 'yyyy-mm-dd',
            value: [new Date()],
            minDate: start,
            onChange: function (p, values, displayValues) {
                //console.log(p, values, displayValues);
                //var prev = new Date($(".item-calendar.item-start input").val());
                //console.log(prev);
                var nextS = new Date(displayValues);
                var nextE = new Date(displayValues);
                nextE.setDate(nextE.getDate() + 60);
                //console.log(displayValues, d);
                $(".item-calendar.item-end input").val(nextE.toJSON().substring(0, 10));
                endCalendar[0].destroy();
                endCalendar = $(".item-calendar.item-end input").calendar({
                    dateFormat: 'yyyy-mm-dd',
                    value: [nextE],
                    minDate: nextS,
                    maxDate: nextE
                });
            }
        });
        var endCalendar = $(".item-calendar.item-end input").calendar();
        //console.log(startCalendar);

        $(".label-checkbox").click(function (e) {
            if ($(this).hasClass('checked')) {
                $(this).removeClass('checked');
                $(this).find('.checkbox-2').removeClass('checked');
                $(this).find('input').attr('checked', 'checked');
            } else {
                $(this).addClass('checked');
                $(this).find('.checkbox-2').addClass('checked');
                $(this).find('input').removeAttr('checked');
            }
            e.preventDefault();
        });

        var __this;
        $('#list').on('click', '.item-time input', function () {
            __this = $(this);
            $(this).picker({
                toolbarTemplate: '<header class="bar bar-nav">\
                                  <button class="button button-link pull-left close-picker">取消</button>\
                                  <button class="button button-link pull-right close-picker">确定</button>\
                                  <h1 class="title">选择时间</h1>\
                                  </header>',
                cols: [
                    {
                        textAlign: 'center',
                        values: ['8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '1', '2', '3', '4', '5', '6', '7']
                        //如果你希望显示文案和实际值不同，可以在这里加一个displayValues: [.....]
                    },
                    {
                        textAlign: 'center',
                        values: ['：']
                        //如果你希望显示文案和实际值不同，可以在这里加一个displayValues: [.....]
                    },
                    {
                        textAlign: 'center',
                        values: ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59']
                    }
                ],
                formatValue: function (p, v, d) {
                    return (d[0] + ':' + d[2]);
                }
            });
        })

        var $labelSwitch = $('.label-switch');
        var $labelCheckbox = $('.label-checkbox');

        $.extend($.fn, {
            addSport: function () {
                var $input = $('.item-time input');
                var $labelSwitch = $('.label-switch');
                var sportData = alarmTime();
                var api = 'sportPlan/saveSportPlan/';
                var success = function (data) {
//                    console.log(data)
                    if (data.success == true) {
                        window.location.href = 'finishplan.html';
                    } else {
                        var $msg = $('#msg');
                        var $reminder = $('#reminder');
                        $reminder.show();
                        $msg.html(data.message);
                        setTimeout(function () {
                            $reminder.hide();
                        }, 2000)
                    }
                };
                var error = function (data) {
//                    alert("获取数据失败！");
                };
//                console.log(sportData);
                $.gjk.ajax.postAjax(api, sportData, success, error, function () {
                }, 'POST', 'saveSportPlan');
            }
        });

        //获取页面数据
        function alarmTime() {
            var $itemContent = $('.item-content');
//                var $labelSwitch = $itemContent.find('.label-switch');
            var $switchCheckBox = $('#switchCheckBox');
            var $labelCheckbox = $switchCheckBox.find('.label-checkbox');
            var $timebox = $switchCheckBox.find('.timebox');
            var $weekState = $('#weekState');
//            console.log(generatedTime())
            var options = {
                "sportId": getUrlParams().id,
                "alarmMonday": generatedTime()[0],
                "alarmTuesday": generatedTime()[1],
                "alarmWednesday": generatedTime()[2],
                "alarmThursday": generatedTime()[3],
                "alarmFriday": generatedTime()[4],
                "alarmSaturday": generatedTime()[5],
                "alarmSunday": generatedTime()[6],
                "alarmWeekday": addWeekState(),
                "startDate": $('#startTime').val() ? $('#startTime').val() : $('#startTime').attr('placeholder'),
                "endDate": $('#endTime').val() ? $('#endTime').val() : $('#endTime').attr('placeholder')
            };

            function generatedTime() {
                var timeDate = [];
                $labelCheckbox.each(function (i) {
                    if ($(this).hasClass('checked')) {
                        if ($timebox.eq(i).find('input').val() == '') {
                            timeDate.push('8:00|1')
//                            console.log($(this))
                        } else {
                            timeDate.push($timebox.eq(i).find('input').val() + '|1')
                        }
                    } else {
                        timeDate.push('8:00|0');
//                        console.log($(this));
                    }
                });
                return timeDate;
            }

            function addWeekState() {
                var state = '';
                if ($weekState.find('.label-switch').attr('data-state') == 1) {
                    if ($weekState.find('.timebox input').val() == '') {
                        state = '8:00|1';
                    } else {
                        state = $weekState.find('.timebox input').val() + '|1'
                    }
                } else {
                    state = '8:00|0'
                }
                return state;
            }

            return options;
        }

        //还原输入框时间值
        function resetValue() {
            $('body').on('click', '.button.button-link.pull-left.close-picker', function () {
                __this.val('');
            })
        }

        resetValue();
        //加载页面数据
        function createPageData() {
            var _url = 'sportPlan/findBySportId';
            var _data = {
                "sportId": getUrlParams().id
            };

            var _success = function (data) {
//                    console.log(data);
                refresh(data);
            };
            var _error = function (data) {
//                console.log(data);
                alert('请求数据失败！')
            };
            $.gjk.ajax.postAjax(_url, _data, _success, _error, function () {
            }, 'POST', 'findByRestId');
        }

        createPageData();

        //刷新页面数据
        function refresh(data) {
//            console.log(data)
//                var alarmTime = createBtnCount(data.data);
            $('.item-start').find('input').attr('placeholder', format(data.data.startDate, 'yyyy-MM-dd'));
            $('.item-end').find('input').attr('placeholder', format(data.data.endDate, 'yyyy-MM-dd'));
//                $('.input-views').text(btnCount(data.data.alarmGetup));
//                //生成选择框、开关样式
            addBtnStyleAndPl(data.data);
            if (getUrlParams().state == 0) {
                $('.content-block').hide();
            }

        }

        //生成对应按钮的样式
        function addBtnStyleAndPl(data) {
            var $gjkItem = $('.gjk-item');
            var hasCl = '<input type="checkbox" checked><div class="checkbox"></div>';
//            console.log(data);
            for (var items in data) {
                if (data[items]) {
                    switch (items) {
                        case 'alarmFriday':
                            changeBtnState(items, data[items]);
                            break;
                        case 'alarmMonday':
                            changeBtnState(items, data[items]);
                            break;
                        case 'alarmTuesday':
                            changeBtnState(items, data[items]);
                            break;
                        case 'alarmWednesday':
                            changeBtnState(items, data[items]);
                            break;
                        case 'alarmThursday':
                            changeBtnState(items, data[items]);
                            break;
                        case 'alarmSaturday':
                            changeBtnState(items, data[items]);
                            break;
                        case 'alarmSunday':
                            changeBtnState(items, data[items]);
                            break;
                        case 'alarmWeekday':
                            var $Weekday = $('.alarmWeekday');
                            $Weekday.find('.label-switch').attr('data-state', deleteState(data[items])[1]);
                            $Weekday.find('.label-switch input').attr('checked', 'checked');
                            $Weekday.find('.timebox input').attr('placeholder', deleteState(data[items])[0]);
                    }
                }
            }

            function changeBtnState(obj, data) {
                if (deleteState(data)[1] == 1) {
                    var $obj = $('.' + obj);
                    $obj.find('.label-checkbox').addClass('checked');
                    $obj.find('.checkbox-2').addClass('checked');
                    $obj.find('.label-switch').html(hasCl);
                    $obj.find('.label-switch').attr('data-state', deleteState(data)[1]);
                    $obj.find('.timebox input').attr('placeholder', deleteState(data)[0]);
                }
            }
        }

        //改变状态值
        $('#switchHtml').on('click', '.label-switch', function () {
            var state = $(this).attr('data-state');
            if (state == 0) {
                $(this).attr('data-state', 1)
            } else {
                $(this).attr('data-state', 0)
            }
        });

        //日期开关状态
        function weekBtnState() {
            var hasCl = '<input type="checkbox"><div class="checkbox"></div>';
            //判断星期的开关
            var missCl = '<div class="checkbox"></div>';
            $labelCheckbox.each(function (i) {
                $(this).on('click', function () {
                    if ($(this).hasClass('checked')) {
                        $labelSwitch.eq($labelCheckbox.index($(this))).html(hasCl);
                    } else {
                        $labelSwitch.eq($labelCheckbox.index($(this))).html(missCl);
                    }
                    $labelSwitch.eq($labelCheckbox.index($(this))).attr('data-state', 0);
                });
            });
            //提醒开关
            $labelSwitch.on('click', function () {
                if ($labelCheckbox.eq($labelSwitch.index($(this))).hasClass('checked')) {
                    var state = $(this).attr('data-state');
                    if (state == 0) {
                        $(this).attr('data-state', 1)
                    } else {
                        $(this).attr('data-state', 0)
                    }
                    return
                }
                $(this).attr('data-state', 0);
            })
        }

        $('.btn-del').on('click', deleteRest);
        function deleteRest() {
            var $longModel = $('#longModel');
            $longModel.show();  //显示模态层
            $longModel.on('click', '.btnRes', function () {
                $longModel.hide();
            });
            $longModel.on('click', '.btnOk', sendDeleFyrest);

            function sendDeleFyrest() {
                var _url = 'sportPlan/deleteBySportId';
                var _data = {
                    "sportId": getUrlParams().id
                };
                var _success = function (data) {
                    if (data.success == true) {
//                        console.log(data);
                        $longModel.hide();
                        window.location.href = 'finishplan.html';
                    }
                };
                var _error = function (data) {
//                    console.log(data);
                    alert('请求数据失败!')
                };
                $.gjk.ajax.postAjax(_url, _data, _success, _error, function () {
                }, 'POST', 'deleteBySportId')
            }
        }

        weekBtnState();   //执行函数
//        })(Zepto);

        $('.item-input.item-calendar').on('click', function () {
            changePicker();
            limitTimeDate();
        });

        $('.button.button-big.btn-save').on('click', $.fn.addSport);
    })
</script>
</body>
</html>

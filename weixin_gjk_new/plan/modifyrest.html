<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title></title>
    <style type="text/css">
        @-ms-viewport {
            width: device-width;
        }

        @-o-viewport {
            width: device-width;
        }

        @viewport {
            width: device-width;
        }
    </style>

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script>
        // Copyright 2014-2015 Twitter, Inc.
        // Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
        if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
            var msViewportStyle = document.createElement('style')
            msViewportStyle.appendChild(
                document.createTextNode(
                    '@-ms-viewport{width:auto!important}'
                )
            )
            document.querySelector('head').appendChild(msViewportStyle)
        }
    </script>
    <link rel="stylesheet" href="../css/boot.css"/>
    <link rel="stylesheet" href="../css/theme.css"/>
    <link rel="stylesheet" href="../css/addplan.css"/>
</head>
<body>
<div class="page-group">
    <div class="page page-current">
        <div role="navigation" class="navbar-fixed-top">
            <div class="container-fluid">
                <div class="pull-left">
                    <a role="backlink" id="goBackPack" class="glyphicon glyphicon-menu-left" href="javascript:;"></a>
                </div>
                <div class="pull-right">
                    <a href="javascript:void();"></a>
                </div>
                <div role="navtitle">
                    修改作息计划
                </div>
            </div>
        </div>
        <div class="content">
            <div id="list">
                <div class="list-block">
                    <ul>
                        <li class="item-content item-link gjk-item gjk-open-calendar">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">开始时间</div>
                                <div class="item-input item-calendar item-start">
                                    <input id="startTime" type="text" placeholder="点击选择日期" readonly="">
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-link gjk-item gjk-open-calendar">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">结束时间</div>
                                <div class="item-input item-calendar item-end">
                                    <input id="endTime" type="text" placeholder="点击选择日期" readonly="">
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="list-block">
                    <ul>
                        <li class="item-content gjk-item">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 field-3">作息类型</div>
                                <div class="col-33 field-3">
                                    <span>提醒时间</span>
                                </div>
                                <div class="col-33 field-3">提醒开关</div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="list-block list-blockx" id="switchHtml">
                    <ul>
                        <!--<li class="item-content gjk-item">-->
                        <!--<div class="item-inner gjk-item-inner row">-->
                        <!--<div class="col-33 input-wrapper" style="text-align: center;">-->
                        <!--<label class="label-checkbox">-->
                        <!--<input type="checkbox">-->
                        <!--<div class="checkbox-2">-->
                        <!--<span>起床</span>-->
                        <!--</div>-->
                        <!--</label>-->
                        <!--</div>-->
                        <!--<div class="col-33 input-wrapper">-->
                        <!--<div class="item-input item-time">-->
                        <!--<label class="label-time gjk-open-input">-->


                        <!--<div class="timebox">-->
                        <!--<input type="text" value="8：00" readonly>-->
                        <!--</div>-->
                        <!--</label>-->
                        <!--</div>-->
                        <!--</div>-->
                        <!--<div class="col-33 input-wrapper">-->
                        <!--<div class="item-input item-switch">-->
                        <!--<label class="label-switch">-->
                        <!--<input type="checkbox">-->
                        <!--<div class="checkbox"></div>-->
                        <!--</label>-->
                        <!--</div>-->
                        <!--</div>-->
                        <!--</div>-->
                        <!--</li>-->
                        <li class="item-content gjk-item">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <label class="label-checkbox checked">
                                        <input type="checkbox">
                                        <div class="checkbox-2 checked">
                                            <span>睡觉</span>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-33 input-wrapper" style="text-align: center;">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">
                                            <div class="timebox">
                                                <input type="text" placeholder="8：00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-33 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="0">
                                            <input type="checkbox">
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>


                <div class="content-block">
                    <p><a href="#" class="button button-big btn-save">保存</a></p>
                    <p><a href="#" class="button button-big btn-del">删除</a></p>
                </div>


            </div>
        </div>
    </div>
</div>
<!--删除按钮-->
<div id="longModel">
    <div class="modelBody">
        <div class="modelContext">
            <!--<p>添加成功！</p>-->
            <p>确定要删除信息吗？</p>
        </div>
        <div class="modelFooter">
            <a href="javascript:;" class="btnRes">取消</a>
            <a href="javascript:;" class="btnOk">确定</a>
        </div>
    </div>
</div>
<!--model层-->
<div id="reminder">
    <div class="reminderBody">
        <div class="reminderContext">
            <div><span id="msg"></span><!--<span id="num">2s</span>--></div>
        </div>
    </div>
</div>
<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<!--script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.js' charset='utf-8'></script-->
<script type="text/javascript" src="../js/sm.js" charset="utf-8"></script>
<script type="text/javascript" src="../js/zepto.touch.js" charset="utf-8"></script>
<script src="../js/underscore.js"></script>
<script src="../js/cookie.js"></script>
<script src="../js/gjk.js"></script>
<script src="../js/base.js"></script>
<script type='text/javascript'>
    $.init();
    /*tap  替换成了click */
    $.refreshScroller();
    var start = new Date();
    var endTimes = $('.item-input.item-calendar.item-end').find('input');
    var startE = new Date()
    start.setDate(start.getDate() - 1);
    startE.setDate(startE.getDate() + 60)
    var startCalendar = $(".item-calendar.item-start input").calendar({
        dateFormat: 'yyyy-mm-dd',
//        value: [new Date()],
        minDate: start,
        maxDate: startE,
        onChange: function (p, values, displayValues) {
            var nextS = new Date(displayValues);
            var nextE = new Date(endTimes.val() ? endTimes.val() : endTimes.attr('placeholder'));
            nextE.setDate(nextE.getDate());
            var nextEnd = new Date(displayValues);
            nextEnd.setDate(nextEnd.getDate() + 60);
            $(".item-calendar.item-end input").val(nextE.toJSON().substring(0, 10));
            endCalendar[0].destroy();
            endCalendar = $(".item-calendar.item-end input").calendar({
                dateFormat: 'yyyy-mm-dd',
                value: [nextE],
                minDate: nextS,
                maxDate: nextEnd
            });
        }
    });
    var endCalendar = $(".item-calendar.item-end input").calendar()

    $(".label-checkbox").click(function (e) {
        if ($(this).hasClass('checked')) {
            $(this).removeClass('checked');
            $(this).find('.checkbox-2').removeClass('checked');
            $(this).find('input').attr('checked', 'checked');
        } else {
            $(this).addClass('checked');
            $(this).find('.checkbox-2').addClass('checked');
            $(this).find('input').removeAttr('checked');
        }
        e.preventDefault();
    });

//    $(".item-singe input").picker({
//        toolbarTemplate: '<header class="bar bar-nav">\
//		  <button class="button button-link pull-left close-picker">取消</button>\
//		  <button class="button button-link pull-right close-picker">确定</button>\
//		  <h1 class="title">选择次数</h1>\
//		  </header>',
//        cols: [
//            {
//                textAlign: 'center',
//                values: ['1次', '2次', '3次', '4次', '5次']
//            }
//        ]
//    });

    var __this;
    $('#list').on('click', '.item-time input', function () {
        __this = $(this);
        $(this).picker({
            toolbarTemplate: '<header class="bar bar-nav">\
                                  <button class="button button-link pull-left close-picker">取消</button>\
                                  <button class="button button-link pull-right close-picker">确定</button>\
                                  <h1 class="title">选择时间</h1>\
                                  </header>',
            cols: [
                {
                    textAlign: 'center',
                    values: ['21', '22', '23', '24', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']
                    //如果你希望显示文案和实际值不同，可以在这里加一个displayValues: [.....]
                },
                {
                    textAlign: 'center',
                    values: ['：']
                    //如果你希望显示文案和实际值不同，可以在这里加一个displayValues: [.....]
                },
                {
                    textAlign: 'center',
                    values: ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59']
                }
            ],
            formatValue: function (p, v, d) {
                return (d[0] + ':' + d[2]);
            }
        });
    })

    var options = {
        inputReduce: '.input-reduce',
        inputPlus: '.input-plus',
        inputView: '.input-views',
        min: 1,
        max: 10,
        count: 1,
        tipMessage: 'error'
    }

    var $labelSwitch = $('.label-switch');
    var $labelCheckbox = $('.label-checkbox');

    $.extend($.fn, {

        addRest: function () {
            var $input = $('.timebox input');
            var $labelSwitch = $('.label-switch');
            var restData = {
                "restId": getUrlParams().id,
                "alarmGetup": '',
                "alarmSleep": ($($input.picker()).val() ? $($input.picker()).val() : '21:00') + '|' + $labelSwitch.attr('data-state'),
                "startDate": $('#startTime').val() ? $('#startTime').val() : $('#startTime').attr('placeholder'),
                "endDate": $('#endTime').val() ? $('#endTime').val() : $('#endTime').attr('placeholder')
            };
            if(endTimeCantThanStartTime(restData.startDate, restData.endDate)){
                alertTextModelHint("结束时间不能小于开始时间");
                return
            }
            var api = 'restPlan/saveRestPlan/';
            var success = function (data) {
//                console.log(data)
                if (data.success == true) {
                    window.location.href =  'finishplan.html?state=' + getUrlParams().state
                } else {
                    alertTextModelHint(data.message)
                }
            };
            var error = function (data) {
//                alert("获取数据失败！");
            };
//            console.log(restData);
            $.gjk.ajax.postAjax(api, restData, success, error, function () {
            }, 'POST', 'saveRestPlan');
        }
    });


    //加载页面数据
    function createPageData() {
        var _url = 'restPlan/findByRestId';
        var _data = {
            "primaryKey": getUrlParams().id
        };

        var _success = function (data) {
//            console.log(data);
            refresh(data);
        };
        var _error = function (data) {
//            console.log(data);
//            alert('请求数据失败！')
        };
        if(getUrlParams().state == 1){
            $.gjk.ajax.postAjax(_url, _data, _success, _error, function () {
            }, 'POST', 'findByRestId');
        }else {
            $.gjk.ajax.requestPostOrder(_url, _data, _success, _error, function () {
            }, 'POST', 'findByRestId');
        }

    }

    createPageData();

    //刷新页面数据
    function refresh(data) {
        var alarmTime = createBtnCount(data.data);
        $('.item-start').find('input').attr('placeholder', format(data.data.startDate, 'yyyy-MM-dd'));
        $('.item-end').find('input').attr('placeholder', format(data.data.endDate, 'yyyy-MM-dd'));
//        $('.input-views').text(btnCount(data.data.alarmGetup));

        //生成选择框、开关样式
        addBtnStyleAndPl(alarmTime)
        if (getUrlParams().state == 0) {
            $('.content-block').hide();
        }

    }

    //生成对应按钮的样式
    function addBtnStyleAndPl(data) {
        var $gjkItem = $('.gjk-item');
        $gjkItem.find('.timebox input').attr('placeholder',deleteState(data[1])[0])
        if(deleteState(data[1])[1] == 1){
            $('.label-switch').attr('data-state',1).find('input').attr('checked','')
        }
    }


    //生成对应的按钮
    function addBtn() {
        var html = options.switchHtml;

        for (var i = 0; i < options.htmlNode.length; i++) {
            html += options.switchHtml;
        }
        options.btnParent.html(html);
    }

    //改变状态值
    changeBtnStates2()

    $('.btn-save').on('click', function () {
        if($('.label-checkbox').hasClass('checked')){   //判断用户是否勾选提醒
            $.fn.addRest();
        }else {
            alertTextModelHint("请勾选睡觉提醒时间")
        }
    });
    //日期开关状态
    function weekBtnState() {
        var hasCl = '<input type="checkbox"><div class="checkbox"></div>';
        //判断星期的开关
        var missCl = '<div class="checkbox"></div>';
        $labelCheckbox.each(function (i) {
            $(this).on('click', function () {
                if ($(this).hasClass('checked')) {
                    $labelSwitch.eq($labelCheckbox.index($(this))).html(hasCl);
                    $labelSwitch.eq($labelCheckbox.index($(this))).attr('data-state', '1');
                    $labelSwitch.eq($labelCheckbox.index($(this))).find('input').attr('checked', 'checked');
                    return
                } else {
                    $labelSwitch.eq($labelCheckbox.index($(this))).html(missCl);
                }
                $labelSwitch.eq($labelCheckbox.index($(this))).attr('data-state', 0);
            });
        });
    }

    $('.btn-del').on('click', deleteRest);
    function deleteRest() {
        var $longModel = $('#longModel');
        $longModel.show();  //显示模态层
        $longModel.on('click', '.btnRes', function () {
            $longModel.hide();
        });
        $longModel.on('click', '.btnOk', sendDeleFyrest);

        function sendDeleFyrest() {
            var _url = 'restPlan/deleteByRestId';
            var _data = {
                "primaryKey": getUrlParams().id
            };
            var _success = function (data) {
                if (data.success == true) {
//                    console.log(data);
                    $longModel.hide();
                    window.location.href ='finishplan.html?state=' + getUrlParams().state
                }
            };
            var _error = function (data) {
//                console.log(data);
//                alert('请求数据失败!')
            };
            $.gjk.ajax.postAjax(_url, _data, _success, _error, function () {
            }, 'POST', 'deleteByRestId')
        }
    }

    weekBtnState();   //执行函数

    //还原输入框时间值
    function resetValue() {
        $('body').on('click', '.button.button-link.pull-left.close-picker', function () {
            __this.val('');
        })
    }
    resetValue();

    $('.item-input.item-calendar').on('click', function () {
        changePicker();
        limitTimeDate();
    });
    $('#goBackPack').on('click',function () {
        window.location.href = 'finishplan.html?state=' + getUrlParams().state;
    })
    //    $('.item-number').NumberPicker();
</script>
</body>
</html>

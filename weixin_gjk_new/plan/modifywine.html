<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title></title>
    <style type="text/css">
        @-ms-viewport {
            width: device-width;
        }

        @-o-viewport {
            width: device-width;
        }

        @viewport {
            width: device-width;
        }
    </style>

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script>
        // Copyright 2014-2015 Twitter, Inc.
        // Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
        if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
            var msViewportStyle = document.createElement('style')
            msViewportStyle.appendChild(
                document.createTextNode(
                    '@-ms-viewport{width:auto!important}'
                )
            )
            document.querySelector('head').appendChild(msViewportStyle)
        }
    </script>
    <link rel="stylesheet" href="../css/boot.css"/>
    <link rel="stylesheet" href="../css/theme.css"/>
    <link rel="stylesheet" href="../css/addplan.css"/>
</head>
<body>
<div class="page-group">
    <div class="page page-current">
        <div role="navigation" class="navbar-fixed-top">
            <div class="container-fluid">
                <div class="pull-left">
                    <a role="backlink" id="goBackPack" class="glyphicon glyphicon-menu-left" href="javascript:;"></a>
                </div>
                <div class="pull-right">
                    <a href="javascript:void();"></a>
                </div>
                <div role="navtitle">
                    修改戒酒计划
                </div>
            </div>
        </div>
        <div class="content">
            <div id="list">
                <div class="list-block">
                    <ul>
                        <li class="item-content item-link gjk-item gjk-open-calendar">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">开始时间</div>
                                <div class="item-input item-calendar item-start">
                                    <input id="startTime" type="text" placeholder="点击选择日期" readonly="">
                                </div>
                            </div>
                        </li>
                        <li class="item-content item-link gjk-item gjk-open-calendar">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">结束时间</div>
                                <div class="item-input item-calendar item-end">
                                    <input id="endTime" type="text" placeholder="点击选择日期" readonly="">
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="list-block">
                    <ul>
                        <li class="item-content item-link gjk-item gjk-open-input">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">您平均每周饮酒几次？</div>
                                <div class="item-input item-singe">
                                    <input type="text" placeholder="点击选择次数" readonly="">
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="list-block">
                    <ul>
                        <li class="item-content gjk-item">
                            <div class="item-inner gjk-item-inner">
                                <div class="item-title">每日提醒次数</div>
                                <div class="item-after item-number">
                                    <i class="input-reduce">-</i>
                                    <span class="input-views">1</span>
                                    <i class="input-plus">+</i>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="list-block">
                    <ul>
                        <li class="item-content gjk-item">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-50 field">提醒时间</div>
                                <div class="col-50 field">提醒开关</div>
                            </div>
                        </li>
                    </ul>
                </div>


                <div class="list-block list-blockx" id="switchHtml">
                    <ul>
                        <li class="item-content gjk-item">
                            <div class="item-inner gjk-item-inner row">
                                <div class="col-50 input-wrapper">
                                    <div class="item-input item-time">
                                        <label class="label-time gjk-open-input">

                                            <div class="timebox">
                                                <input type="text" placeholder="08:00" readonly>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-50 input-wrapper">
                                    <div class="item-input item-switch">
                                        <label class="label-switch" data-state="1">
                                            <input type="checkbox" checked>
                                            <div class="checkbox"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>


                <div class="content-block">
                    <p><a href="#" class="button button-big btn-save">保存</a></p>
                    <p><a href="#" class="button button-big btn-del">删除</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
<!--删除按钮-->
<div id="longModel">
    <div class="modelBody">
        <div class="modelContext">
            <!--<p>添加成功！</p>-->
            <p>确定要删除信息吗？</p>
        </div>
        <div class="modelFooter">
            <a href="javascript:;" class="btnRes">取消</a>
            <a href="javascript:;" class="btnOk">确定</a>
        </div>
    </div>
</div>
<!--model层-->
<div id="reminder">
    <div class="reminderBody">
        <div class="reminderContext">
            <div><span id="msg"></span><!--<span id="num">2s</span>--></div>
        </div>
    </div>
</div>
<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<!--script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.js' charset='utf-8'></script-->
<script type="text/javascript" src="../js/sm.js" charset="utf-8"></script>
<script type="text/javascript" src="../js/zepto.touch.js" charset="utf-8"></script>
<script src="../js/underscore.js"></script>
<script src="../js/cookie.js"></script>
<script src="../js/gjk.js"></script>
<script src="../js/base.js"></script>
<script type='text/javascript'>
    $.init();
    /*tap  替换成了click */
    $.refreshScroller();
    var start = new Date();
    var endTimes = $('.item-input.item-calendar.item-end').find('input');
    start.setDate(start.getDate() - 1);
    var startE = new Date()
    startE.setDate(startE.getDate() + 60)
    var startCalendar = $(".item-calendar.item-start input").calendar({
        dateFormat: 'yyyy-mm-dd',
//        value: [new Date()],
        minDate: start,
        maxDate: startE,
        onChange: function (p, values, displayValues) {
            var nextS = new Date(displayValues);
            var nextE = new Date(endTimes.val() ? endTimes.val() : endTimes.attr('placeholder'));
            nextE.setDate(nextE.getDate());
            var nextEnd = new Date(displayValues);
            nextEnd.setDate(nextEnd.getDate() + 60);
            $(".item-calendar.item-end input").val(nextE.toJSON().substring(0, 10));
            endCalendar[0].destroy();
            endCalendar = $(".item-calendar.item-end input").calendar({
                dateFormat: 'yyyy-mm-dd',
                value: [nextE],
                minDate: nextS,
                maxDate: nextEnd
            });
        }
    });
    var endCalendar = $(".item-calendar.item-end input").calendar()
    //console.log(startCalendar);

    $(".label-checkbox").click(function () {
        if ($(this).hasClass('checked')) {
            $(this).removeClass('checked');
            $(this).find('.checkbox-2').removeClass('checked');
            $(this).find('input').attr('checked', 'checked');
        } else {
            $(this).addClass('checked');
            $(this).find('.checkbox-2').addClass('checked');
            $(this).find('input').removeAttr('checked');
        }
    });

    var __inputVal;
    $('#list').on('click', ".item-singe input", function () {
        __inputVal = $(this);
        $(this).picker({
            toolbarTemplate: '<header class="bar bar-nav">\
		  <button class="button button-link pull-left close-picker singeRest">取消</button>\
		  <button class="button button-link pull-right close-picker">确定</button>\
		  <h1 class="title">选择次数</h1>\
		  </header>',
            cols: [
                {
                    textAlign: 'center',
                    values: ['1次', '2次', '3次', '4次', '5次', '6次', '7次']
                }
            ]
        });
    });

    var __this;
    $('#switchHtml ul').on('click', '.item-time input', function () {
        __this = $(this);
        $(this).picker({
            toolbarTemplate: '<header class="bar bar-nav">\
				<button class="button button-link pull-left close-picker itemTimeRest">取消</button>\
				<button class="button button-link pull-right close-picker">确定</button>\
				<h1 class="title">选择时间</h1>\
				</header>',
            cols: [
                {
                    textAlign: 'center',
                    values: createNumber($('.item-time input').index($(this)))
                },
                {
                    textAlign: 'center',
                    values: [':']
                },
                {
                    textAlign: 'center',
                    values: ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59']
                }
            ],
            formatValue: function (p, v, d) {
                return (d[0] + ':' + d[2]);
            }
        });
    });

    function createNumber(num) {
        var numArr = [
            ['08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '01', '02', '03', '04', '05', '06', '07'],
            ['12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11'],
            ['18', '19', '20', '21', '22', '23', '24', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17']
        ];
        return numArr[num]
    }

    (function ($) {
        var options = {
            inputReduce: '.input-reduce',
            inputPlus: '.input-plus',
            inputView: '.input-views',
            min: 1,
            max: 3,
            count: 1,
            tipMessage: 'error',
            switchHtml: $('#switchHtml').find('ul').html(),
            btnParent: $('#switchHtml').find('ul'),
            htmlNode: []
        };
        $.extend($.fn, {
            NumberPicker: function (sets) {
                Object.assign(options, sets);
                var _this = this;
                //event
                $(this).find(options.inputReduce).click(function () {
                    if (options.count > options.min) {
                        options.count--;
                        options.htmlNode.pop();
                    } else {
//							$.alert(options.tipMessage);
                        options.count = options.min;
                    }
                    addBtn1();
                    changePlaceholder();
                    $(_this).find(options.inputView).text(options.count);
                });

                $(this).find(options.inputPlus).click(function () {
                    if (options.count < options.max) {
                        options.count++;
                        options.htmlNode.push(options.switchHtml);
                    } else {
//							$.alert(options.tipMessage);
                        options.count = options.max;
                    }
                    addBtn1();
                    changePlaceholder();
                    $(_this).find(options.inputView).text(options.count);
                });

            }
        });
        //生成对应的按钮
        function addBtn1() {
            var html = options.switchHtml;
            for (var i = 1; i < options.htmlNode.length + 1; i++) {

                html += '<li class="item-content gjk-item">' +
                    '<div class="item-inner gjk-item-inner row">' +
                    '<div class="col-50 input-wrapper">' +
                    '<div class="item-input item-time">' +
                    '<label class="label-time gjk-open-input">' +
                    '<div class="timebox">' +
                    '<input data-num="' + i + '" type="text" placeholder="8：00" readonly="">' +
                    '</div>' +
                    '</label>' +
                    '</div>' +
                    '</div>' +
                    '<div class="col-50 input-wrapper">' +
                    '<div class="item-input item-switch">' +
                    '<label class="label-switch" data-state="1">' +
                    '<input type="checkbox" checked="">' +
                    '<div class="checkbox"></div>' +
                    '</label>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</li>';
            }
            options.btnParent.html(html);
        }

        function changePlaceholder() {
            var $input = $('#switchHtml').find('li .timebox input');
            $input.each(function () {
                switch ($(this).attr('data-num')) {
                    case '0':
                        $(this).attr('placeholder', '08:00');
                        break;
                    case '1':
                        $(this).attr('placeholder', '12:00');
                        break;
                    case '2':
                        $(this).attr('placeholder', '18:00');
                        break;
                    default:
                        $(this).attr('placeholder', '08:00');
                        break;
                }
            })
        }

        $('body').on('click', '.singeRest', function () {
            __inputVal.val('')
        });

        //还原输入框时间值
        $('body').on('click', '.itemTimeRest', function () {
            __this.val('')
        });

        //加载页面数据
        function createPageData() {
            var _url = 'abstinencePlan/findById';
            var _data = {
                "primaryKey": getUrlParams().id
            };

            var _success = function (data) {
//                console.log(data);
                refresh(data);
            };
            var _error = function (data) {
//                console.log(data);
//                alert('请求数据失败！')
            };
            if(getUrlParams().state == 1){
                $.gjk.ajax.postAjax(_url, _data, _success, _error, function () {
                }, 'POST', 'findById');
            }else {
                $.gjk.ajax.requestPostOrder(_url, _data, _success, _error, function () {
                }, 'POST', 'findById');
            }

        }

        createPageData();

        //判断状态值：
        function judgeState() {
            var _state = getUrlParams().state;
            if (_state == 0) {
                $('.content-block').hide();
            }
        }

        judgeState();
        //刷新页面数据
        function refresh(data) {
            var alarmTime = createBtnCount(data.data);
            $('.item-start').find('input').attr('placeholder', format(data.data.startDate, 'yyyy-MM-dd'));
            $('.item-end').find('input').attr('placeholder', format(data.data.endDate, 'yyyy-MM-dd'));
            $('.item-singe').find('input').attr('placeholder', data.data.weekSum + '次');

            $('.input-views').text(btnCount(alarmTime));
            //生成对应的按钮
            addBtn();
            function addBtn() {
                var html = options.switchHtml;
                for (var i = 0; i < btnCount(alarmTime) - 1; i++) {
                    html += options.switchHtml;
                }
                options.btnParent.html(html);
            }

            addBtnStyleAndPl(alarmTime)

        }

        //生成对应按钮的样式
        function addBtnStyleAndPl(data) {
            var hasCl = '<input type="checkbox" checked><div class="checkbox"></div>';
            var noCl = '<input type="checkbox"><div class="checkbox"></div>';
            var $gjkItem = $('.gjk-item');
            for (var i = 0; i < data.length; i++) {
                if (data[i]) {
                    if (deleteState(data[i])[1] == 1) {
                        $('.label-switch').eq(i).attr('data-state', deleteState(data[i])[1]);
                        $($gjkItem.find('.timebox input')[i]).attr('placeholder', deleteState(data[i])[0])
                        $('.label-switch').eq(i).html(hasCl);
                    } else if (deleteState(data[i])[1] == 0) {
                        $('.label-switch').eq(i).attr('data-state', deleteState(data[i])[1]);
                        $($gjkItem.find('.timebox input')[i]).attr('placeholder', deleteState(data[i])[0])
                        $('.label-switch').eq(i).html(noCl);
                    }
                }
            }
        }

        //生成按钮的数量
        function createBtnCount(obj) {
            var exp = new RegExp('alarmTime');
            var alertTimes = [];
            for (var items in obj) {
                if (exp.test(items)) {
                    alertTimes.push(obj[items])
                }
            }
            return alertTimes;
        }

        //改变状态值
        changeBtnStates2()

    })(Zepto);

    $('.item-number').NumberPicker();

    (function () {

        $('.btn-save').on('click', function () {
            var $itemContent = $('.item-content');
            var $labelSwitch = $itemContent.find('.label-switch');

            function alarmTime() {
                var options = {
                    "abstinenceId": getUrlParams().id,
                    "weekSum": parseInt($(".item-singe input").picker()[0].value) || 1,
                    "alarmTime1": "",
                    "alarmTime2": "",
                    "alarmTime3": "",
                    "startDate": $('#startTime').val() ? $('#startTime').val() : $('#startTime').attr('placeholder'),
                    "endDate": $('#endTime').val() ? $('#endTime').val() : $('#endTime').attr('placeholder')
                };
                for (var i = 0; i < 3; i++) {
                    if ($itemContent.find('.item-time input').picker()[i]) {
                        if ($itemContent.find('.item-time input').picker()[i].value == "") {
                            options['alarmTime' + (i + 1)] = $($itemContent.find('.item-time input').picker()[i]).attr('placeholder') + '|' + $labelSwitch[i].getAttribute('data-state')
                        } else {
                            options['alarmTime' + (i + 1)] = $itemContent.find('.item-time input').picker()[i].value + '|' + $labelSwitch[i].getAttribute('data-state');
                        }
                    } else {
                        options['alarmTime' + (i + 1)] = "";
                    }
                }
                return options;
            }

            //ajax发送数据
            function sendajax() {
                var optionsDatas = alarmTime();
                if(endTimeCantThanStartTime(alarmTime().startDate, alarmTime().endDate)){
                    alertTextModelHint("结束时间不能小于开始时间");
                    return
                }
                var searchStr = "alarmTime";
                if (tiquAlartTime(optionsDatas, searchStr)) {
                    var options = {
                        _url: 'abstinencePlan/saveAbstinencePlan/',
                        _success: function (data) {
//                        console.log(data)
                            if (data.success == true) {
                                window.location.href =  'finishplan.html?state=' + getUrlParams().state
                            } else {
                                alertTextModelHint(data.message)
                            }
                        },
                        _error: function (data) {
//                        alert("获取数据失败！");
                        },
                        _data: optionsDatas
                    };
                    $.gjk.ajax.postAjax(options._url, options._data, options._success, options._error, function () {
                    }, 'POST', 'saveAbstinencePlan');
                } else {
                    alertTextModelHint("提示时间相同，请重新选择时间")
                }
            }

            sendajax();
        });

        $('.btn-del').on('click', deleteRest);
        function deleteRest() {
            var $longModel = $('#longModel');
            $longModel.show();  //显示模态层
            $longModel.on('click', '.btnRes', function () {
                $longModel.hide();
            });
            $longModel.on('click', '.btnOk', sendDeleFyrest);

            function sendDeleFyrest() {
                var _url = 'abstinencePlan/deleteById';
                var _data = {
                    "primaryKey": getUrlParams().id
                };
                var _success = function (data) {
                    if (data.success == true) {
                        $longModel.hide();
                        window.location.href = 'finishplan.html?state=' + getUrlParams().state
                    }
                };
                var _error = function (data) {
                };
                $.gjk.ajax.postAjax(_url, _data, _success, _error, function () {
                }, 'POST', 'deleteById')
            }
        }

        $('.item-input.item-calendar').on('click', function () {
            changePicker();
            limitTimeDate();
        });
        $('#goBackPack').on('click',function () {
            window.location.href = 'finishplan.html?state=' + getUrlParams().state;
        })
    })()
</script>
</body>
</html>
